<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B2B 자동메일 관리 대시보드</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .stat-card.success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        .stat-card.warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        .stat-card.info {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }
        .btn-execute {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            transition: all 0.3s ease;
        }
        .btn-execute:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            color: white;
        }
        .table-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .loading {
            display: none;
        }
        .alert-custom {
            border-radius: 10px;
            border: none;
        }
    </style>
</head>
<body class="bg-light">
    <div class="container-fluid py-4">
        <!-- 헤더 -->
        <div class="row mb-4">
            <div class="col-12">
                <h1 class="display-6 fw-bold text-primary">
                    <i class="fas fa-envelope-open-text me-3"></i>
                    Coway B2B 청구서 자동메일 관리 대시보드
                </h1>
                <p class="text-muted">automail-guide.md Step 1-3 구현 현황 및 관리</p>
            </div>
        </div>

        <!-- 통계 카드 -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-0">오늘 생성</h6>
                            <h3 class="mb-0" th:text="${todayDataCount}">0</h3>
                        </div>
                        <i class="fas fa-calendar-day fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card success">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-0">전체 활성</h6>
                            <h3 class="mb-0" th:text="${totalActiveCount}">0</h3>
                        </div>
                        <i class="fas fa-check-circle fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card info">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-0">파일 생성 완료</h6>
                            <h3 class="mb-0" th:text="${fileCreatedCount}">0</h3>
                        </div>
                        <i class="fas fa-file-alt fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card warning">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-0">메일 발송 완료</h6>
                            <h3 class="mb-0" th:text="${mailSentCount}">0</h3>
                        </div>
                        <i class="fas fa-envelope-circle-check fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- 실행 버튼 -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="table-container">
                    <h5 class="mb-3">
                        <i class="fas fa-play-circle me-2"></i>
                        수동 실행
                    </h5>
                    <div class="row">
                        <div class="col-md-4 mb-2">
                            <button class="btn btn-execute w-100" onclick="executeStep1()">
                                <i class="fas fa-search me-2"></i>
                                Step 1: 대상 조회
                            </button>
                        </div>
                        <div class="col-md-4 mb-2">
                            <button class="btn btn-execute w-100" onclick="executeFullProcess()">
                                <i class="fas fa-cogs me-2"></i>
                                Step 1+2: 전체 실행
                            </button>
                        </div>
                        <div class="col-md-4 mb-2">
                            <button class="btn btn-execute w-100" onclick="executeBatchJob()">
                                <i class="fas fa-rocket me-2"></i>
                                Batch Job 실행
                            </button>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-2">
                            <button class="btn btn-execute w-100" onclick="getFileCreationTargets()">
                                <i class="fas fa-file-search me-2"></i>
                                파일 생성 대상 조회
                            </button>
                        </div>
                        <div class="col-md-4 mb-2">
                            <button class="btn btn-execute w-100" onclick="executeAllFileCreation()">
                                <i class="fas fa-file-export me-2"></i>
                                전체 파일 생성
                            </button>
                        </div>
                        <div class="col-md-4 mb-2">
                            <button class="btn btn-execute w-100" onclick="executeFileCreationBatch()">
                                <i class="fas fa-cogs me-2"></i>
                                파일 생성 배치 실행
                            </button>
                        </div>
                    </div>
                    <!-- 템플릿 파일 상태 확인 -->
                    <div class="row mt-3">
                        <div class="col-md-4 mb-2">
                            <button class="btn btn-outline-warning w-100" onclick="checkTemplateStatus()">
                                <i class="fas fa-file-medical me-2"></i>
                                템플릿 파일 상태 확인
                            </button>
                        </div>
                        <div class="col-md-8">
                            <div id="templateStatusResult" class="alert alert-info d-none">
                                <strong>템플릿 파일 상태:</strong>
                                <div id="templateStatusContent"></div>
                            </div>
                        </div>
                    </div>
                    <!-- Step 4 메일 발송 기능 추가 -->
                    <div class="row">
                        <div class="col-md-4 mb-2">
                            <button class="btn btn-execute w-100" onclick="getMailSendTargets()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                <i class="fas fa-envelope-open me-2"></i>
                                Step 4-1: 당월 메일 발송 대상 조회
                            </button>
                        </div>
                        <div class="col-md-4 mb-2">
                            <button class="btn btn-execute w-100" onclick="executeAllMailSending()" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                                <i class="fas fa-paper-plane me-2"></i>
                                Step 4-2: 전체 메일 발송
                            </button>
                        </div>
                        <div class="col-md-4 mb-2">
                            <button class="btn btn-execute w-100" onclick="executeStep4Batch()" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                                <i class="fas fa-magic me-2"></i>
                                Step 4: 배치 작업 실행
                            </button>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-3">
                            <button class="btn btn-outline-info" onclick="previewMailTemplate()">
                                <i class="fas fa-eye me-2"></i>
                                메일 템플릿 미리보기
                            </button>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-outline-primary" onclick="getMailSendStatistics()">
                                <i class="fas fa-chart-bar me-2"></i>
                                메일 발송 통계
                            </button>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-outline-info" onclick="showMailSendResults()">
                                <i class="fas fa-envelope-check me-2"></i>
                                메일 발송 결과 확인
                            </button>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-4">
                            <button class="btn btn-outline-warning w-100" onclick="viewBatchHistory()">
                                <i class="fas fa-history me-2"></i>
                                배치 실행 이력 조회
                            </button>
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-outline-success w-100" onclick="createSampleData()">
                                <i class="fas fa-database me-2"></i>
                                테스트용 샘플 데이터 생성
                            </button>
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-outline-secondary w-100" onclick="refreshDashboard()">
                                <i class="fas fa-sync-alt me-2"></i>
                                대시보드 새로고침
                            </button>
                        </div>
                    </div>
                    <!-- 청구서 양식 생성 기능 추가 -->
                    <div class="row mt-3">
                        <div class="col-md-4">
                            <button class="btn btn-execute w-100" onclick="getTemplateGenerationTargets()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                <i class="fas fa-file-invoice me-2"></i>
                                사업자 양식 생성 대상 조회
                            </button>
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-execute w-100" onclick="generateAllBusinessTemplates()" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                                <i class="fas fa-file-contract me-2"></i>
                                B2B 사업자 청구서 양식 생성
                            </button>
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-outline-secondary" onclick="viewTemplateGenerationStatus()">
                                <i class="fas fa-chart-line me-2"></i>
                                양식 생성 현황 조회
                            </button>
                        </div>
                    </div>
                    <!-- B2B 사업자 양식 수동 생성 버튼 추가 -->
                    <div class="row mt-3">
                        <div class="col-md-12">
                            <button class="btn btn-execute w-100" onclick="openManualTemplateModal()" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                                <i class="fas fa-hand-pointer me-2"></i>
                                B2B 사업자 양식 수동 생성
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 결과 메시지 -->
        <div class="row mb-4">
            <div class="col-12">
                <div id="resultMessage" style="display: none;"></div>
                <div id="loadingMessage" class="alert alert-info alert-custom loading">
                    <i class="fas fa-spinner fa-spin me-2"></i>
                    처리 중입니다...
                </div>
            </div>
        </div>

        <!-- 최근 데이터 목록 -->
        <div class="row">
            <div class="col-12">
                <div class="table-container">
                    <h5 class="mb-3">
                        <i class="fas fa-list me-2"></i>
                        전체 자동메일 데이터 목록
                        <span class="badge bg-primary ms-2" th:text="${#lists.size(recentData)}">0</span>
                    </h5>
                    
                    <!-- 페이징 컨트롤 -->
                    <div class="row mb-3" th:if="${#lists.size(recentData) > 20}">
                        <div class="col-md-6">
                            <div class="d-flex align-items-center">
                                <label for="pageSize" class="form-label me-2 mb-0">페이지당 표시:</label>
                                <select id="pageSize" class="form-select form-select-sm" style="width: auto;" onchange="changePageSize()">
                                    <option value="20">20개</option>
                                    <option value="50">50개</option>
                                    <option value="100">100개</option>
                                    <option value="all">전체</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <nav aria-label="페이지 네비게이션">
                                <ul class="pagination pagination-sm justify-content-end mb-0" id="pagination">
                                    <!-- 페이징 버튼이 JavaScript로 생성됩니다 -->
                                </ul>
                            </nav>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-hover" id="dataTable">
                            <thead class="table-dark">
                                <tr>
                                    <th>SEQ</th>
                                    <th>사업자번호</th>
                                    <th>고객명</th>
                                    <th>묶음번호</th>
                                    <th>주문번호</th>
                                    <th>발송일</th>
                                    <th>청구년월</th>
                                    <th>이메일</th>
                                    <th>파일생성</th>
                                    <th>메일발송</th>
                                    <th>생성일시</th>
                                    <th>액션</th>
                                </tr>
                            </thead>
                            <tbody id="dataTableBody">
                                <tr th:each="data : ${recentData}" th:if="${not #lists.isEmpty(recentData)}" class="data-row">
                                    <td th:text="${data.seq}">1</td>
                                    <td th:text="${data.stcd2}">123-45-67890</td>
                                    <td th:text="${data.custNm}">고객명</td>
                                    <td th:text="${data.zgrpno}">12345</td>
                                    <td th:text="${data.orderNo}">ORDER001</td>
                                    <td th:text="${data.fxday != null ? data.fxday : '-'}">15</td>
                                    <td th:text="${data.recpYm != null ? data.recpYm : '-'}">202401</td>
                                    <td th:text="${data.email}">test@example.com</td>
                                    <td>
                                        <span th:if="${data.fileCreateFlag == 'Y'}" class="badge bg-success">완료</span>
                                        <span th:if="${data.fileCreateFlag == 'N'}" class="badge bg-warning">대기</span>
                                    </td>
                                    <td>
                                        <span th:if="${data.mailSendFlag == 'Y'}" class="badge bg-primary">완료</span>
                                        <span th:if="${data.mailSendFlag == 'N'}" class="badge bg-secondary">대기</span>
                                    </td>
                                    <td th:text="${#temporals.format(data.dtCreateDate, 'yyyy-MM-dd HH:mm')}">2024-01-01 08:00</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary me-1" 
                                                th:onclick="'viewDetail(' + ${data.seq} + ')'">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-success" 
                                                th:onclick="'createFilesForData(' + ${data.seq} + ')'"
                                                th:if="${data.fileCreateFlag == 'N'}">
                                            <i class="fas fa-file-plus"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" 
                                                th:onclick="'sendMailBySeq(' + ${data.seq} + ')'"
                                                th:if="${data.fileCreateFlag == 'Y' and data.mailSendFlag == 'N'}">
                                            <i class="fas fa-paper-plane"></i>
                                        </button>
                                    </td>
                                </tr>
                                <tr th:if="${#lists.isEmpty(recentData)}">
                                    <td colspan="12" class="text-center text-muted py-4">
                                        <i class="fas fa-inbox fa-2x mb-2"></i><br>
                                        생성된 데이터가 없습니다.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 상세 모달 -->
    <div class="modal fade" id="detailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">자동메일 데이터 상세</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="detailContent">
                        <!-- 상세 내용이 여기에 로드됩니다 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 메일 발송 결과 확인 모달 -->
    <div class="modal fade" id="mailResultModal" tabindex="-1" aria-labelledby="mailResultModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="mailResultModalLabel">
                        <i class="fas fa-envelope-check me-2"></i>
                        메일 발송 결과 확인
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- 필터 및 검색 영역 -->
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="resultDateFilter" class="form-label">날짜 필터</label>
                            <input type="date" class="form-control" id="resultDateFilter" 
                                   onchange="filterMailResults()">
                        </div>
                        <div class="col-md-4">
                            <label for="resultStatusFilter" class="form-label">발송 상태</label>
                            <select class="form-select" id="resultStatusFilter" onchange="filterMailResults()">
                                <option value="">전체</option>
                                <option value="Y">발송 성공</option>
                                <option value="E">발송 실패</option>
                            </select>
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <button type="button" class="btn btn-primary me-2" onclick="loadMailResults()">
                                <i class="fas fa-refresh me-1"></i>새로고침
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="clearResultFilters()">
                                <i class="fas fa-eraser me-1"></i>필터 초기화
                            </button>
                        </div>
                    </div>

                    <!-- 통계 영역 -->
                    <div class="row mb-3" id="mailResultStats">
                        <div class="col-md-3">
                            <div class="card text-center">
                                <div class="card-body py-2">
                                    <h6 class="card-title mb-1">전체</h6>
                                    <h4 class="text-primary mb-0" id="totalResultCount">0</h4>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center">
                                <div class="card-body py-2">
                                    <h6 class="card-title mb-1">발송 성공</h6>
                                    <h4 class="text-success mb-0" id="successResultCount">0</h4>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center">
                                <div class="card-body py-2">
                                    <h6 class="card-title mb-1">발송 실패</h6>
                                    <h4 class="text-danger mb-0" id="failResultCount">0</h4>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center">
                                <div class="card-body py-2">
                                    <h6 class="card-title mb-1">성공률</h6>
                                    <h4 class="text-info mb-0" id="successRate">0%</h4>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 결과 테이블 -->
                    <div class="table-responsive">
                        <table class="table table-hover table-sm">
                            <thead class="table-dark">
                                <tr>
                                    <th>SEQ</th>
                                    <th>사업자번호</th>
                                    <th>고객명</th>
                                    <th>청구년월</th>
                                    <th>발송이메일</th>
                                    <th>UMS코드</th>
                                    <th>UMS메시지</th>
                                    <th>UMS키</th>
                                    <th>발송상태</th>
                                    <th>발송시간</th>
                                </tr>
                            </thead>
                            <tbody id="mailResultTableBody">
                                <!-- 데이터가 JavaScript로 로드됩니다 -->
                            </tbody>
                        </table>
                    </div>

                    <!-- 로딩 및 메시지 영역 -->
                    <div id="mailResultLoading" class="text-center py-4" style="display: none;">
                        <i class="fas fa-spinner fa-spin fa-2x text-primary"></i>
                        <div class="mt-2">데이터를 로드하는 중...</div>
                    </div>

                    <div id="mailResultEmpty" class="text-center py-4" style="display: none;">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <div class="h5 text-muted">발송 결과가 없습니다</div>
                        <div class="text-muted">조건을 변경하거나 메일을 발송해보세요.</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                </div>
            </div>
        </div>
    </div>

    <!-- B2B 사업자 양식 수동 생성 모달 -->
    <div class="modal fade" id="manualTemplateModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">B2B 사업자 양식 수동 생성</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body" id="manualTemplateModalBody">
            <!-- 사업자 목록 테이블이 JS로 동적으로 삽입됩니다 -->
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Step 1: 대상 조회 실행
        function executeStep1() {
            showLoading();
            fetch('/automail/api/step1/targets')
                .then(response => response.json())
                .then(data => {
                    hideLoading();
                    if (data.success) {
                        showMessage('success', 
                            `Step 1 실행 완료<br>
                            총 조회: ${data.totalCount}건<br>
                            처리 대상: ${data.validCount}건`);
                    } else {
                        showMessage('danger', 'Step 1 실행 실패: ' + data.message);
                    }
                })
                .catch(error => {
                    hideLoading();
                    showMessage('danger', 'Step 1 실행 중 오류 발생: ' + error.message);
                });
        }

        // 전체 프로세스 실행
        function executeFullProcess() {
            showLoading();
            fetch('/automail/api/execute', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    hideLoading();
                    if (data.success) {
                        showMessage('success', 'Step 1+2 전체 프로세스 실행 완료');
                        setTimeout(() => location.reload(), 2000);
                    } else {
                        showMessage('danger', '전체 프로세스 실행 실패: ' + data.message);
                    }
                })
                .catch(error => {
                    hideLoading();
                    showMessage('danger', '전체 프로세스 실행 중 오류 발생: ' + error.message);
                });
        }

        // Batch Job 실행
        function executeBatchJob() {
            showLoading();
            fetch('/automail/api/batch/run', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    hideLoading();
                    if (data.success) {
                        showMessage('success', 'Batch Job 실행 완료');
                        setTimeout(() => location.reload(), 2000);
                    } else {
                        showMessage('danger', 'Batch Job 실행 실패: ' + data.message);
                    }
                })
                .catch(error => {
                    hideLoading();
                    showMessage('danger', 'Batch Job 실행 중 오류 발생: ' + error.message);
                });
        }

        // 상세 보기
        function viewDetail(seq) {
            fetch(`/automail/api/data/${seq}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // 파일 다운로드 버튼 생성 (파일생성플래그가 Y인 경우만)
                        let downloadButtons = '';
                        if (data.data.fileCreateFlag === 'Y') {
                            downloadButtons = `
                                <div class="col-12 mt-3">
                                    <h6>파일 다운로드</h6>
                                    <div class="d-flex gap-2 flex-wrap">
                                        ${data.data.chgHtmlFilenm ? `
                                            <div class="btn-group" role="group">
                                                <button class="btn btn-outline-primary btn-sm" onclick="downloadFile(${seq}, 'html')">
                                                    <i class="fas fa-download me-1"></i>
                                                    HTML 다운로드
                                                </button>
                                                <button class="btn btn-outline-info btn-sm" onclick="previewFile(${seq}, 'html')">
                                                    <i class="fas fa-eye me-1"></i>
                                                    미리보기
                                                </button>
                                            </div>
                                            <small class="text-muted align-self-center ms-2">${data.data.chgHtmlFilenm}</small>
                                        ` : ''}
                                        ${data.data.chgExcelFilenm ? `
                                            <button class="btn btn-outline-success btn-sm" onclick="downloadFile(${seq}, 'excel')">
                                                <i class="fas fa-download me-1"></i>
                                                EXCEL 다운로드
                                                <small class="d-block text-muted">${data.data.chgExcelFilenm}</small>
                                            </button>
                                        ` : ''}
                                    </div>
                                </div>
                            `;
                        }

                        const content = `
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>기본 정보</h6>
                                    <p><strong>SEQ:</strong> ${data.data.seq}</p>
                                    <p><strong>사업자번호:</strong> ${data.data.stcd2 || '-'}</p>
                                    <p><strong>고객명:</strong> ${data.data.custNm || '-'}</p>
                                    <p><strong>고객코드:</strong> ${data.data.kunnr || '-'}</p>
                                    <p><strong>묶음번호:</strong> ${data.data.zgrpno || '-'}</p>
                                    <p><strong>주문번호:</strong> ${data.data.orderNo || '-'}</p>
                                    <p><strong>발송일:</strong> 
                                        <span id="fxdayDisplay">${data.data.fxday || '-'}</span>
                                        <button class="btn btn-sm btn-outline-primary ms-2" onclick="editFxday(${seq}, '${data.data.fxday || ''}')">
                                            <i class="fas fa-edit"></i> 수정
                                        </button>
                                        <div id="fxdayEditForm" style="display: none;" class="mt-2">
                                            <div class="input-group input-group-sm" style="max-width: 200px;">
                                                <input type="text" id="fxdayInput" class="form-control" 
                                                       placeholder="1-31" maxlength="2" 
                                                       value="${data.data.fxday || ''}"
                                                       onkeypress="return isNumberKey(event)"
                                                       oninput="formatFxdayInput(this)">
                                                <button class="btn btn-success" onclick="saveFxday(${seq})">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                                <button class="btn btn-secondary" onclick="cancelEditFxday()">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                            <small class="text-muted">1~31 사이의 숫자만 입력 가능</small>
                                        </div>
                                    </p>
                                    <p><strong>청구년월:</strong> ${data.data.recpYm || '-'}</p>
                                </div>
                                <div class="col-md-6">
                                    <h6>상태 정보</h6>
                                    <p><strong>자동메일플래그:</strong> 
                                        <span class="badge ${data.data.sendAuto === 'Y' ? 'bg-success' : 'bg-secondary'}">${data.data.sendAuto}</span>
                                    </p>
                                    <p><strong>파일생성플래그:</strong> 
                                        <span class="badge ${data.data.fileCreateFlag === 'Y' ? 'bg-success' : 'bg-warning'}">${data.data.fileCreateFlag}</span>
                                    </p>
                                    <p><strong>메일발송플래그:</strong> 
                                        <span class="badge ${data.data.mailSendFlag === 'Y' ? 'bg-primary' : 'bg-secondary'}">${data.data.mailSendFlag}</span>
                                    </p>
                                    <p><strong>삭제플래그:</strong> ${data.data.delFlag}</p>
                                    <p><strong>생성일시:</strong> ${data.data.dtCreateDate}</p>
                                    <p><strong>이메일:</strong> ${data.data.email || '-'}</p>
                                    <p><strong>이메일2:</strong> ${data.data.email2 || '-'}</p>
                                </div>
                                ${downloadButtons}
                            </div>
                            <div class="row mt-3">
                                <div class="col-12">
                                    <h6>파일 정보</h6>
                                    <p><strong>HTML 원본파일명:</strong> ${data.data.oriHtmlFilenm || '-'}</p>
                                    <p><strong>HTML 변환파일명:</strong> ${data.data.chgHtmlFilenm || '-'}</p>
                                    <p><strong>HTML 파일경로:</strong> ${data.data.htmlFilepath || '-'}</p>
                                    <p><strong>EXCEL 원본파일명:</strong> ${data.data.oriExcelFilenm || '-'}</p>
                                    <p><strong>EXCEL 변환파일명:</strong> ${data.data.chgExcelFilenm || '-'}</p>
                                    <p><strong>EXCEL 파일경로:</strong> ${data.data.excelFilepath || '-'}</p>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-12">
                                    <h6>메일 데이터 (JSON)</h6>
                                    <pre class="bg-light p-3 rounded" style="max-height: 300px; overflow-y: auto;">${data.data.mailData || '데이터 없음'}</pre>
                                </div>
                            </div>
                        `;
                        document.getElementById('detailContent').innerHTML = content;
                        new bootstrap.Modal(document.getElementById('detailModal')).show();
                    } else {
                        showMessage('danger', '상세 정보 조회 실패: ' + data.message);
                    }
                })
                .catch(error => {
                    showMessage('danger', '상세 정보 조회 중 오류 발생: ' + error.message);
                });
        }

        // 로딩 표시
        function showLoading() {
            document.getElementById('loadingMessage').style.display = 'block';
            document.getElementById('resultMessage').style.display = 'none';
        }

        // 로딩 숨김
        function hideLoading() {
            document.getElementById('loadingMessage').style.display = 'none';
        }

        // 메시지 표시
        function showMessage(type, message) {
            const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
            const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle';
            
            document.getElementById('resultMessage').innerHTML = `
                <div class="alert ${alertClass} alert-custom">
                    <i class="fas ${icon} me-2"></i>
                    ${message}
                </div>
            `;
            document.getElementById('resultMessage').style.display = 'block';
        }

        // 통계 새로고침
        function refreshStatistics() {
            fetch('/automail/api/statistics')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // 통계 업데이트 로직 (필요시 구현)
                        console.log('통계 새로고침 완료', data.statistics);
                    }
                })
                .catch(error => {
                    console.error('통계 새로고침 실패:', error);
                });
        }

        // 배치 실행 이력 조회
        function viewBatchHistory() {
            fetch('/automail/api/batch/history')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const content = `
                            <div class="row">
                                <div class="col-12">
                                    <h6>배치 실행 현황</h6>
                                    <p><strong>현재 월:</strong> ${data.currentMonth}</p>
                                    <p><strong>이번 달 실행 여부:</strong> 
                                        <span class="badge ${data.hasExecutedThisMonth ? 'bg-success' : 'bg-warning'}">
                                            ${data.hasExecutedThisMonth ? '실행됨' : '미실행'}
                                        </span>
                                    </p>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-12">
                                    <h6>최근 실행 이력</h6>
                                    <pre class="bg-light p-3 rounded" style="max-height: 400px; overflow-y: auto; font-size: 12px;">${data.recentExecutions}</pre>
                                </div>
                            </div>
                        `;
                        document.getElementById('detailContent').innerHTML = content;
                        document.querySelector('#detailModal .modal-title').textContent = '배치 실행 이력';
                        new bootstrap.Modal(document.getElementById('detailModal')).show();
                    } else {
                        showMessage('danger', '배치 실행 이력 조회 실패: ' + data.message);
                    }
                })
                .catch(error => {
                    showMessage('danger', '배치 실행 이력 조회 중 오류 발생: ' + error.message);
                });
        }

        // === 파일 생성 관련 함수들 ===

        // 파일 생성 대상 조회
        function getFileCreationTargets() {
            showLoading();
            fetch('/api/file-creation/targets')
                .then(response => response.json())
                .then(data => {
                    hideLoading();
                    if (data.success) {
                        showMessage('success', 
                            `파일 생성 대상 조회 완료<br>
                            총 대상: ${data.totalCount}건`);
                        
                        // 대상 목록을 모달로 표시
                        if (data.totalCount > 0) {
                            showFileCreationTargets(data.targets);
                        }
                    } else {
                        showMessage('danger', '파일 생성 대상 조회 실패: ' + data.message);
                    }
                })
                .catch(error => {
                    hideLoading();
                    showMessage('danger', '파일 생성 대상 조회 중 오류 발생: ' + error.message);
                });
        }

        // 파일 생성 대상 목록 표시
        function showFileCreationTargets(targets) {
            let tableRows = '';
            targets.forEach(target => {
                tableRows += `
                    <tr>
                        <td>${target.seq}</td>
                        <td>${target.stcd2 || '-'}</td>
                        <td>${target.custNm || '-'}</td>
                        <td>${target.orderNo || '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-success" onclick="createFilesForData(${target.seq})">
                                <i class="fas fa-file-plus"></i> 파일 생성
                            </button>
                        </td>
                    </tr>
                `;
            });

            const content = `
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>SEQ</th>
                                <th>사업자번호</th>
                                <th>고객명</th>
                                <th>주문번호</th>
                                <th>액션</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableRows}
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('detailContent').innerHTML = content;
            document.querySelector('#detailModal .modal-title').textContent = '파일 생성 대상 목록';
            new bootstrap.Modal(document.getElementById('detailModal')).show();
        }

        // 개별 파일 생성
        function createFilesForData(seq) {
            showLoading();
            fetch(`/api/file-creation/create/${seq}`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    hideLoading();
                    if (data.success) {
                        showMessage('success', `SEQ ${seq} 파일 생성 완료`);
                        setTimeout(() => location.reload(), 2000);
                    } else {
                        showMessage('danger', `SEQ ${seq} 파일 생성 실패: ` + data.message);
                    }
                })
                .catch(error => {
                    hideLoading();
                    showMessage('danger', `SEQ ${seq} 파일 생성 중 오류 발생: ` + error.message);
                });
        }

        // 전체 파일 생성
        function executeAllFileCreation() {
            if (!confirm('전체 파일 생성을 실행하시겠습니까?')) {
                return;
            }
            
            showLoading();
            fetch('/api/file-creation/execute-all', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    hideLoading();
                    if (data.success) {
                        showMessage('success', 
                            `전체 파일 생성 완료<br>
                            총 대상: ${data.totalCount}건<br>
                            성공: ${data.successCount}건<br>
                            실패: ${data.failCount}건`);
                        setTimeout(() => location.reload(), 3000);
                    } else {
                        showMessage('danger', '전체 파일 생성 실패: ' + data.message);
                    }
                })
                .catch(error => {
                    hideLoading();
                    showMessage('danger', '전체 파일 생성 중 오류 발생: ' + error.message);
                });
        }

        // 파일 생성 배치 실행
        function executeFileCreationBatch() {
            if (!confirm('파일 생성 배치 작업을 실행하시겠습니까?')) {
                return;
            }
            
            showLoading();
            fetch('/api/file-creation/batch/execute', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    hideLoading();
                    if (data.success) {
                        showMessage('success', '파일 생성 배치 작업 실행 완료');
                        setTimeout(() => location.reload(), 2000);
                    } else {
                        showMessage('danger', '파일 생성 배치 작업 실행 실패: ' + data.message);
                    }
                })
                .catch(error => {
                    hideLoading();
                    showMessage('danger', '파일 생성 배치 작업 실행 중 오류 발생: ' + error.message);
                });
        }

        // 테스트용 샘플 데이터 생성
        function createSampleData() {
            showLoading();
            fetch('/api/file-creation/test/create-sample-data', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    hideLoading();
                    if (data.success) {
                        const content = `
                            <div class="row">
                                <div class="col-12">
                                    <h6>테스트용 샘플 데이터</h6>
                                    <p class="text-info">${data.instruction}</p>
                                    <h6 class="mt-3">샘플 SQL 쿼리:</h6>
                                    <pre class="bg-light p-3 rounded" style="font-size: 12px;">INSERT INTO b2b_automail_dt 
(STCD2, KUNNR, CUST_NM, EMAIL, ZGRPNO, ORDER_NO, SEND_AUTO, FILE_CREATE_FLAG, DEL_FLAG, DT_CREATE_DATE, MAILDATA) 
VALUES 
('1048118121', 'TEST001', '지에스건설(주)', 'test@example.com', 12345, '20BC42405078', 'Y', 'N', 'N', NOW(), '${data.sampleData.replace(/'/g, "\\'")}');</pre>
                                    <h6 class="mt-3">샘플 JSON 데이터:</h6>
                                    <pre class="bg-light p-3 rounded" style="max-height: 400px; overflow-y: auto; font-size: 12px;">${JSON.stringify(JSON.parse(data.sampleData), null, 2)}</pre>
                                </div>
                            </div>
                        `;
                        document.getElementById('detailContent').innerHTML = content;
                        document.querySelector('#detailModal .modal-title').textContent = '테스트용 샘플 데이터';
                        new bootstrap.Modal(document.getElementById('detailModal')).show();
                        
                        showMessage('success', '샘플 데이터 생성 완료');
                    } else {
                        showMessage('danger', '샘플 데이터 생성 실패: ' + data.message);
                    }
                })
                .catch(error => {
                    hideLoading();
                    showMessage('danger', '샘플 데이터 생성 중 오류 발생: ' + error.message);
                });
        }

        // === Step 4 메일 발송 관련 함수들 ===

        // Step 4-1: 메일 발송 대상 조회
        function getMailSendTargets() {
            showLoading();
            fetch('/api/mail-send/targets')
                .then(response => response.json())
                .then(data => {
                    hideLoading();
                    if (data.success) {
                        showMessage('success', 
                            `Step 4-1: 당월 메일 발송 대상 조회 완료<br>
                            총 대상: ${data.totalCount}건`);
                        
                        // 대상 목록을 모달로 표시
                        if (data.totalCount > 0) {
                            showMailSendTargets(data.targets);
                        }
                    } else {
                        showMessage('danger', 'Step 4-1: 당월 메일 발송 대상 조회 실패: ' + data.message);
                    }
                })
                .catch(error => {
                    hideLoading();
                    showMessage('danger', 'Step 4-1: 당월 메일 발송 대상 조회 중 오류 발생: ' + error.message);
                });
        }

        // 메일 발송 대상 목록 표시
        function showMailSendTargets(targets) {
            let tableRows = '';
            targets.forEach(target => {
                tableRows += `
                    <tr>
                        <td>${target.seq}</td>
                        <td>${target.stcd2 || '-'}</td>
                        <td>${target.custNm || '-'}</td>
                        <td>${target.email || '-'}</td>
                        <td>${target.recpYm || '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="sendMailBySeq(${target.seq})">
                                <i class="fas fa-paper-plane"></i> 메일 발송
                            </button>
                        </td>
                    </tr>
                `;
            });

            const content = `
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>SEQ</th>
                                <th>사업자번호</th>
                                <th>고객명</th>
                                <th>이메일</th>
                                <th>청구년월</th>
                                <th>액션</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableRows}
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('detailContent').innerHTML = content;
            document.querySelector('#detailModal .modal-title').textContent = 'Step 4-1: 당월 메일 발송 대상 목록';
            new bootstrap.Modal(document.getElementById('detailModal')).show();
        }

        // 개별 메일 발송
        function sendMailBySeq(seq) {
            if (!confirm(`SEQ ${seq} 건에 대해 메일을 발송하시겠습니까?`)) {
                return;
            }
            
            showLoading();
            fetch(`/api/mail-send/send/${seq}`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    hideLoading();
                    if (data.success) {
                        showMessage('success', `SEQ ${seq} 메일 발송 완료<br>고객: ${data.customerName}`);
                        setTimeout(() => location.reload(), 2000);
                    } else {
                        showMessage('danger', `SEQ ${seq} 메일 발송 실패: ` + data.message);
                    }
                })
                .catch(error => {
                    hideLoading();
                    showMessage('danger', `SEQ ${seq} 메일 발송 중 오류 발생: ` + error.message);
                });
        }

        // Step 4-2: 전체 메일 발송
        function executeAllMailSending() {
            if (!confirm('전체 메일 발송을 실행하시겠습니까?')) {
                return;
            }
            
            showLoading();
            fetch('/api/mail-send/execute-all', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    hideLoading();
                    if (data.success) {
                        showMessage('success', 
                            `Step 4-2: 전체 메일 발송 완료<br>
                            총 대상: ${data.totalCount}건<br>
                            처리 완료: ${data.processedCount}건`);
                        setTimeout(() => location.reload(), 3000);
                    } else {
                        showMessage('danger', 'Step 4-2: 전체 메일 발송 실패: ' + data.message);
                    }
                })
                .catch(error => {
                    hideLoading();
                    showMessage('danger', 'Step 4-2: 전체 메일 발송 중 오류 발생: ' + error.message);
                });
        }

        // Step 4: 배치 작업 실행
        function executeStep4Batch() {
            if (!confirm('Step 4 배치 작업을 실행하시겠습니까?')) {
                return;
            }
            
            showLoading();
            fetch('/api/mail-send/batch/execute', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    hideLoading();
                    if (data.success) {
                        showMessage('success', 
                            `Step 4: 배치 작업 실행 완료<br>
                            실행 시간: ${data.executedAt}`);
                        setTimeout(() => location.reload(), 2000);
                    } else {
                        showMessage('danger', 'Step 4: 배치 작업 실행 실패: ' + data.message);
                    }
                })
                .catch(error => {
                    hideLoading();
                    showMessage('danger', 'Step 4: 배치 작업 실행 중 오류 발생: ' + error.message);
                });
        }

        // 메일 템플릿 미리보기
        function previewMailTemplate() {
            const custNm = prompt('고객명을 입력하세요 (기본값: 테스트고객)', '테스트고객');
            const recpYear = prompt('청구년도를 입력하세요 (기본값: 2024)', '2024');
            const recpMonth = prompt('청구월을 입력하세요 (기본값: 12)', '12');
            
            if (!custNm || !recpYear || !recpMonth) {
                return;
            }
            
            showLoading();
            fetch(`/api/mail-send/preview-template?custNm=${encodeURIComponent(custNm)}&recpYear=${recpYear}&recpMonth=${recpMonth}`)
                .then(response => response.json())
                .then(data => {
                    hideLoading();
                    if (data.success) {
                        const content = `
                            <div class="row">
                                <div class="col-12">
                                    <h6>메일 템플릿 미리보기</h6>
                                    <div class="alert alert-info">
                                        <strong>템플릿 변수:</strong><br>
                                        • 고객명: ${data.custNm}<br>
                                        • 청구년도: ${data.recpYear}년<br>
                                        • 청구월: ${data.recpMonth}월
                                    </div>
                                    <h6>변수 치환 정보:</h6>
                                    <pre class="bg-light p-3 rounded">${JSON.stringify(data.templateVariables, null, 2)}</pre>
                                    <div class="alert alert-warning">
                                        <i class="fas fa-info-circle me-2"></i>
                                        실제 HTML 템플릿 렌더링은 실제 메일 발송 시 확인할 수 있습니다.
                                    </div>
                                </div>
                            </div>
                        `;
                        document.getElementById('detailContent').innerHTML = content;
                        document.querySelector('#detailModal .modal-title').textContent = '메일 템플릿 미리보기';
                        new bootstrap.Modal(document.getElementById('detailModal')).show();
                        
                        showMessage('success', '메일 템플릿 미리보기 생성 완료');
                    } else {
                        showMessage('danger', '메일 템플릿 미리보기 실패: ' + data.message);
                    }
                })
                .catch(error => {
                    hideLoading();
                    showMessage('danger', '메일 템플릿 미리보기 중 오류 발생: ' + error.message);
                });
        }

        // 메일 발송 통계 조회
        function getMailSendStatistics() {
            showLoading();
            fetch('/api/mail-send/statistics')
                .then(response => response.json())
                .then(data => {
                    hideLoading();
                    if (data.success) {
                        const stats = data.statistics;
                        const content = `
                            <div class="row">
                                <div class="col-12">
                                    <h6>메일 발송 통계</h6>
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="card text-center bg-primary text-white">
                                                <div class="card-body">
                                                    <h5>${stats.todayTargetCount || 0}</h5>
                                                    <p class="mb-0">오늘 발송 대상</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="card text-center bg-success text-white">
                                                <div class="card-body">
                                                    <h5>${stats.sentCount || 0}</h5>
                                                    <p class="mb-0">발송 완료</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="card text-center bg-warning text-white">
                                                <div class="card-body">
                                                    <h5>${stats.pendingCount || 0}</h5>
                                                    <p class="mb-0">발송 대기</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mt-3">
                                        <p><strong>마지막 업데이트:</strong> ${stats.lastUpdated || '정보 없음'}</p>
                                    </div>
                                </div>
                            </div>
                        `;
                        document.getElementById('detailContent').innerHTML = content;
                        document.querySelector('#detailModal .modal-title').textContent = '메일 발송 통계';
                        new bootstrap.Modal(document.getElementById('detailModal')).show();
                        
                        showMessage('success', '메일 발송 통계 조회 완료');
                    } else {
                        showMessage('danger', '메일 발송 통계 조회 실패: ' + data.message);
                    }
                })
                .catch(error => {
                    hideLoading();
                    showMessage('danger', '메일 발송 통계 조회 중 오류 발생: ' + error.message);
                });
        }

        // === 페이징 관련 함수들 ===
        let currentPage = 1;
        let pageSize = 20;
        let totalRows = 0;
        let allRows = [];

        // 페이지 로드 시 페이징 초기화
        document.addEventListener('DOMContentLoaded', function() {
            initializePagination();
            // 5분마다 통계 새로고침
            setInterval(refreshStatistics, 300000);
        });

        // 페이징 초기화
        function initializePagination() {
            const rows = document.querySelectorAll('.data-row');
            allRows = Array.from(rows);
            totalRows = allRows.length;
            
            if (totalRows > 20) {
                showPage(1);
                updatePagination();
            }
        }

        // 페이지 크기 변경
        function changePageSize() {
            const select = document.getElementById('pageSize');
            pageSize = select.value === 'all' ? totalRows : parseInt(select.value);
            currentPage = 1;
            showPage(currentPage);
            updatePagination();
        }

        // 특정 페이지 표시
        function showPage(page) {
            currentPage = page;
            
            if (pageSize >= totalRows) {
                // 전체 표시
                allRows.forEach(row => row.style.display = '');
                return;
            }
            
            const startIndex = (page - 1) * pageSize;
            const endIndex = startIndex + pageSize;
            
            allRows.forEach((row, index) => {
                if (index >= startIndex && index < endIndex) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        // 페이징 버튼 업데이트
        function updatePagination() {
            const pagination = document.getElementById('pagination');
            if (!pagination || pageSize >= totalRows) {
                if (pagination) pagination.innerHTML = '';
                return;
            }
            
            const totalPages = Math.ceil(totalRows / pageSize);
            let paginationHtml = '';
            
            // 이전 버튼
            paginationHtml += `
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="goToPage(${currentPage - 1}); return false;">이전</a>
                </li>
            `;
            
            // 페이지 번호 버튼
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);
            
            if (startPage > 1) {
                paginationHtml += `<li class="page-item"><a class="page-link" href="#" onclick="goToPage(1); return false;">1</a></li>`;
                if (startPage > 2) {
                    paginationHtml += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
            }
            
            for (let i = startPage; i <= endPage; i++) {
                paginationHtml += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="goToPage(${i}); return false;">${i}</a>
                    </li>
                `;
            }
            
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    paginationHtml += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
                paginationHtml += `<li class="page-item"><a class="page-link" href="#" onclick="goToPage(${totalPages}); return false;">${totalPages}</a></li>`;
            }
            
            // 다음 버튼
            paginationHtml += `
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="goToPage(${currentPage + 1}); return false;">다음</a>
                </li>
            `;
            
            pagination.innerHTML = paginationHtml;
        }

        // 페이지 이동
        function goToPage(page) {
            const totalPages = Math.ceil(totalRows / pageSize);
            if (page < 1 || page > totalPages) return;
            
            showPage(page);
            updatePagination();
        }

        // === 파일 다운로드 관련 함수들 ===

        // 파일 다운로드
        function downloadFile(seq, fileType) {
            const url = `/automail/api/download/${seq}/${fileType}`;
            
            showMessage('info', `${fileType.toUpperCase()} 파일 다운로드를 시작합니다.`);
            
            // 간단한 링크 방식으로 다운로드
            const link = document.createElement('a');
            link.href = url;
            link.target = '_blank';
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // 다운로드 완료 메시지는 약간의 지연 후 표시
            setTimeout(() => {
                showMessage('success', `${fileType.toUpperCase()} 파일 다운로드가 시작되었습니다.`);
            }, 500);
        }

        // 파일 미리보기 (HTML 파일의 경우)
        function previewFile(seq, fileType) {
            if (fileType === 'html') {
                const previewUrl = `/automail/api/preview/${seq}/html`;
                
                // 미리보기 창 열기 전에 URL 유효성 검사
                fetch(previewUrl, { method: 'HEAD' })
                    .then(response => {
                        if (response.ok) {
                            window.open(previewUrl, '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
                        } else {
                            throw new Error(`미리보기 실패: ${response.status} ${response.statusText}`);
                        }
                    })
                    .catch(error => {
                        console.error('미리보기 오류:', error);
                        showMessage('danger', `HTML 파일 미리보기 실패: ${error.message}`);
                    });
            } else {
                showMessage('warning', 'EXCEL 파일은 미리보기를 지원하지 않습니다.');
            }
        }

        // === 편집 관련 함수들 ===

        // 발송일 편집
        function editFxday(seq, currentFxday) {
            const fxdayInput = document.getElementById('fxdayInput');
            fxdayInput.value = currentFxday;
            document.getElementById('fxdayEditForm').style.display = 'block';
        }

        // 발송일 저장
        function saveFxday(seq) {
            const fxdayValue = document.getElementById('fxdayInput').value.trim();
            
            // 입력 값 검증
            if (!fxdayValue) {
                showMessage('danger', '발송일을 입력하세요.');
                return;
            }
            
            // 숫자만 입력 가능한지 체크
            if (!/^\d+$/.test(fxdayValue)) {
                showMessage('danger', '숫자만 입력 가능합니다.');
                return;
            }
            
            // 앞의 0 제거 후 범위 체크
            const fxdayInt = parseInt(fxdayValue);
            if (fxdayInt < 1 || fxdayInt > 31) {
                showMessage('danger', '발송일은 1부터 31까지만 입력 가능합니다.');
                return;
            }
            
            showLoading();
            
            // PUT 요청으로 발송일 업데이트
            fetch(`/automail/api/data/${seq}/fxday`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    fxday: fxdayInt
                })
            })
                .then(response => response.json())
                .then(data => {
                    hideLoading();
                    if (data.success) {
                        // 화면에 업데이트된 값 반영
                        document.getElementById('fxdayDisplay').textContent = data.newFxday;
                        document.getElementById('fxdayEditForm').style.display = 'none';
                        
                        showMessage('success', 
                            `발송일이 ${data.oldFxday || '없음'}에서 ${data.newFxday}로 업데이트되었습니다.`);
                    } else {
                        showMessage('danger', '발송일 업데이트 실패: ' + data.message);
                    }
                })
                .catch(error => {
                    hideLoading();
                    showMessage('danger', '발송일 업데이트 중 오류 발생: ' + error.message);
                });
        }

        // 발송일 취소
        function cancelEditFxday() {
            document.getElementById('fxdayEditForm').style.display = 'none';
        }

        // 숫자 키 검사
        function isNumberKey(event) {
            const key = event.key;
            // 숫자, 백스페이스, 델리트, 탭, 화살표 키만 허용
            if (/^[0-9]$/.test(key) || 
                ['Backspace', 'Delete', 'Tab', 'ArrowLeft', 'ArrowRight'].includes(key)) {
                return true;
            }
            event.preventDefault();
            return false;
        }

        // 발송일 포맷 처리
        function formatFxdayInput(input) {
            // 숫자가 아닌 문자 제거
            let value = input.value.replace(/\D/g, '');
            
            // 최대 2자리까지만 허용
            value = value.slice(0, 2);
            
            // 31을 초과하는 값 입력 방지
            const num = parseInt(value);
            if (num > 31) {
                value = '31';
            }
            
            input.value = value;
        }

        // === 청구서 양식 생성 관련 함수들 ===

        // 사업자 청구서 양식 생성 대상 조회
        function getTemplateGenerationTargets() {
            showLoading();
            fetch('/automail/api/templates/targets')
                .then(response => response.json())
                .then(data => {
                    hideLoading();
                    if (data.success) {
                        const totalCount = data.totalCount || 0;
                        const targets = data.targets || [];
                        
                        let message = `사업자 청구서 양식 생성 대상 조회 완료\n\n`;
                        message += `▪ 전체 대상 사업자 수: ${totalCount}개\n\n`;
                        
                        if (targets.length > 0) {
                            message += `주요 사업자 목록 (최대 5개):\n`;
                            targets.slice(0, 5).forEach((target, index) => {
                                message += `${index + 1}. ${target.businessNm} (${target.businessNo})\n`;
                                message += `   - 인감날인: ${target.stampYn === 'Y' ? '사용' : '미사용'}\n`;
                                message += `   - 고객센터안내: ${target.csGuideYn === 'Y' ? '사용' : '미사용'}\n`;
                            });
                            
                            if (targets.length > 5) {
                                message += `... 외 ${targets.length - 5}개 사업자\n`;
                            }
                        }
                        
                        showMessage('info', message);
                    } else {
                        showMessage('danger', '대상 조회 실패: ' + data.message);
                    }
                })
                .catch(error => {
                    hideLoading();
                    console.error('대상 조회 오류:', error);
                    showMessage('danger', '대상 조회 중 오류 발생: ' + error.message);
                });
        }

        // B2B 사업자 청구서 양식 전체 생성
        function generateAllBusinessTemplates() {
            if (!confirm('전체 사업자의 청구서 양식(HTML, Excel)을 생성하시겠습니까?\n\n처리 시간이 다소 소요될 수 있습니다.')) {
                return;
            }
            
            showLoading();
            
            fetch('/automail/api/templates/generate-all', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
                .then(response => response.json())
                .then(data => {
                    hideLoading();
                    if (data.success) {
                        showMessage('success', `✅ ${data.message}\n\n실행 시간: ${data.executedAt}`);
                    } else {
                        showMessage('danger', `❌ 양식 생성 실패: ${data.message}`);
                    }
                })
                .catch(error => {
                    hideLoading();
                    console.error('양식 생성 오류:', error);
                    showMessage('danger', '양식 생성 중 오류 발생: ' + error.message);
                });
        }

        // 양식 생성 현황 조회 (향후 구현 예정)
        function viewTemplateGenerationStatus() {
            showMessage('info', '양식 생성 현황 조회 기능은 향후 구현 예정입니다.\n\n현재는 서버 로그를 통해 생성 상태를 확인해주세요.');
        }

        // === 템플릿 파일 상태 확인 관련 함수들 ===

        // === 메일 발송 결과 확인 관련 함수들 ===

        // 메일 발송 결과 모달 표시
        function showMailSendResults() {
            const modal = new bootstrap.Modal(document.getElementById('mailResultModal'));
            modal.show();
            
            // 오늘 날짜를 기본값으로 설정
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('resultDateFilter').value = today;
            
            // 결과 로드
            loadMailResults();
        }

        // 메일 발송 결과 로드
        function loadMailResults() {
            const dateFilter = document.getElementById('resultDateFilter').value;
            const statusFilter = document.getElementById('resultStatusFilter').value;
            
            // 로딩 표시
            document.getElementById('mailResultLoading').style.display = 'block';
            document.getElementById('mailResultEmpty').style.display = 'none';
            document.getElementById('mailResultTableBody').innerHTML = '';
            
            let url = '/api/mail-send/results';
            const params = new URLSearchParams();
            
            if (dateFilter) {
                params.append('targetDate', dateFilter);
            }
            
            if (params.toString()) {
                url += '?' + params.toString();
            }
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('mailResultLoading').style.display = 'none';
                    
                    if (data.success && data.results) {
                        let filteredResults = data.results;
                        
                        // 상태 필터 적용
                        if (statusFilter) {
                            filteredResults = data.results.filter(result => result.MAIL_SEND_FLAG === statusFilter);
                        }
                        
                        if (filteredResults.length > 0) {
                            displayMailResults(filteredResults);
                            updateMailResultStats(filteredResults);
                        } else {
                            document.getElementById('mailResultEmpty').style.display = 'block';
                            updateMailResultStats([]);
                        }
                    } else {
                        document.getElementById('mailResultEmpty').style.display = 'block';
                        showMessage('danger', '메일 발송 결과 조회 실패: ' + data.message);
                        updateMailResultStats([]);
                    }
                })
                .catch(error => {
                    document.getElementById('mailResultLoading').style.display = 'none';
                    document.getElementById('mailResultEmpty').style.display = 'block';
                    console.error('메일 발송 결과 조회 오류:', error);
                    showMessage('danger', '메일 발송 결과 조회 중 오류 발생: ' + error.message);
                    updateMailResultStats([]);
                });
        }

        // 메일 발송 결과 테이블에 표시
        function displayMailResults(results) {
            const tbody = document.getElementById('mailResultTableBody');
            tbody.innerHTML = '';
            
            results.forEach(result => {
                const row = document.createElement('tr');
                
                // 발송 상태에 따른 배지 클래스 설정
                let statusBadge = '';
                if (result.MAIL_SEND_FLAG === 'Y') {
                    statusBadge = '<span class="badge bg-success">성공</span>';
                } else if (result.MAIL_SEND_FLAG === 'E') {
                    statusBadge = '<span class="badge bg-danger">실패</span>';
                } else {
                    statusBadge = '<span class="badge bg-secondary">대기</span>';
                }
                
                // 발송이메일 표시 (여러 이메일 중 하나 선택)
                let sendEmail = '';
                const emails = [result.EMAIL, result.EMAIL2, result.EMAIL3, result.EMAIL4, 
                               result.EMAIL5, result.EMAIL6, result.EMAIL7];
                const validEmails = emails.filter(email => email && email.trim() !== '');
                if (validEmails.length > 0) {
                    sendEmail = validEmails[0]; // 첫 번째 유효한 이메일 사용
                    if (validEmails.length > 1) {
                        sendEmail += ` (외 ${validEmails.length - 1}개)`;
                    }
                }
                
                // 날짜 포맷팅
                let sendDate = '';
                if (result.MAIL_SEND_DATE) {
                    const date = new Date(result.MAIL_SEND_DATE);
                    sendDate = date.toLocaleString('ko-KR', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                }
                
                row.innerHTML = `
                    <td>${result.AUTOMAIL_SEQ || ''}</td>
                    <td>${result.STCD2 || ''}</td>
                    <td>${result.CUST_NM || ''}</td>
                    <td>${result.RECP_YM || ''}</td>
                    <td class="text-break" style="max-width: 200px;" title="${sendEmail}">${sendEmail}</td>
                    <td>${result.UMS_CODE || ''}</td>
                    <td class="text-break" style="max-width: 150px;" title="${result.UMS_MSG || ''}">${result.UMS_MSG || ''}</td>
                    <td>${result.UMS_KEY || ''}</td>
                    <td>${statusBadge}</td>
                    <td>${sendDate}</td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // 메일 발송 결과 통계 업데이트
        function updateMailResultStats(results) {
            const total = results.length;
            const success = results.filter(r => r.MAIL_SEND_FLAG === 'Y').length;
            const fail = results.filter(r => r.MAIL_SEND_FLAG === 'E').length;
            const successRate = total > 0 ? Math.round((success / total) * 100) : 0;
            
            document.getElementById('totalResultCount').textContent = total;
            document.getElementById('successResultCount').textContent = success;
            document.getElementById('failResultCount').textContent = fail;
            document.getElementById('successRate').textContent = successRate + '%';
        }

        // 메일 발송 결과 필터 적용
        function filterMailResults() {
            loadMailResults();
        }

        // 결과 필터 초기화
        function clearResultFilters() {
            document.getElementById('resultDateFilter').value = '';
            document.getElementById('resultStatusFilter').value = '';
            loadMailResults();
        }

        // 대시보드 새로고침
        function refreshDashboard() {
            if (confirm('대시보드를 새로고침하시겠습니까?')) {
                location.reload();
            }
        }

        // 템플릿 파일 상태 확인
        function checkTemplateStatus() {
            showLoading();
            fetch('/api/file-creation/template-status')
                .then(response => response.json())
                .then(data => {
                    hideLoading();
                    if (data.success && data.templateStatus) {
                        let content = '<div class="table-responsive"><table class="table table-sm table-bordered">';
                        content += '<thead class="table-dark"><tr><th>사업자번호</th><th>HTML 템플릿</th><th>Excel 템플릿</th><th>상태 메시지</th></tr></thead><tbody>';
                        
                        data.templateStatus.forEach(status => {
                            const htmlStatus = status.htmlTemplateExists ? 
                                '<span class="badge bg-success">존재</span>' : 
                                '<span class="badge bg-danger">없음</span>';
                            const excelStatus = status.excelTemplateExists ? 
                                '<span class="badge bg-success">존재</span>' : 
                                '<span class="badge bg-danger">없음</span>';
                            const rowClass = status.bothTemplatesExist ? '' : 'table-warning';
                            
                            content += `<tr class="${rowClass}">
                                <td>${status.businessNumber}</td>
                                <td>${htmlStatus}</td>
                                <td>${excelStatus}</td>
                                <td>${status.message}</td>
                            </tr>`;
                        });
                        
                        content += '</tbody></table></div>';
                        
                        // 요약 정보 추가
                        const totalCount = data.templateStatus.length;
                        const completeCount = data.templateStatus.filter(s => s.bothTemplatesExist).length;
                        const missingCount = totalCount - completeCount;
                        
                        content = `
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <div class="text-center">
                                        <div class="h5 text-primary">${totalCount}</div>
                                        <div class="text-muted">총 사업자수</div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="text-center">
                                        <div class="h5 text-success">${completeCount}</div>
                                        <div class="text-muted">템플릿 완료</div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="text-center">
                                        <div class="h5 text-danger">${missingCount}</div>
                                        <div class="text-muted">템플릿 누락</div>
                                    </div>
                                </div>
                            </div>
                        ` + content;
                        
                        document.getElementById('templateStatusContent').innerHTML = content;
                        document.getElementById('templateStatusResult').classList.remove('d-none');
                        document.getElementById('templateStatusResult').classList.add('d-block');
                        
                        if (missingCount > 0) {
                            document.getElementById('templateStatusResult').className = 'alert alert-warning d-block';
                            showMessage('warning', `템플릿 파일 상태 조회 완료 - ${missingCount}개 사업자의 템플릿 파일이 누락되었습니다.`);
                        } else {
                            document.getElementById('templateStatusResult').className = 'alert alert-success d-block';
                            showMessage('success', '템플릿 파일 상태 조회 완료 - 모든 템플릿 파일이 정상입니다.');
                        }
                    } else {
                        showMessage('danger', '템플릿 파일 상태 조회 실패: ' + data.message);
                    }
                })
                .catch(error => {
                    hideLoading();
                    showMessage('danger', '템플릿 파일 상태 조회 중 오류 발생: ' + error.message);
                });
        }

        // === B2B 사업자 양식 수동 생성 관련 함수들 ===
        function openManualTemplateModal() {
            showLoading();
            fetch('/automail/api/templates/targets')
                .then(response => response.json())
                .then(data => {
                    hideLoading();
                    if (data.success && data.targets && data.targets.length > 0) {
                        renderManualTemplateTable(data.targets);
                        new bootstrap.Modal(document.getElementById('manualTemplateModal')).show();
                    } else {
                        showMessage('danger', '사업자 양식 생성 대상이 없습니다.');
                    }
                })
                .catch(error => {
                    hideLoading();
                    showMessage('danger', '사업자 목록 조회 중 오류 발생: ' + error.message);
                });
        }

        function renderManualTemplateTable(targets) {
            let tableRows = targets.map((target, idx) => `
                <tr>
                    <td><input type="checkbox" class="manual-template-checkbox" value="${target.businessNo}"></td>
                    <td>${target.businessNo}</td>
                    <td>${target.businessNm}</td>
                    <td>${target.stampYn === 'Y' ? '사용' : '미사용'}</td>
                    <td>${target.csGuideYn === 'Y' ? '사용' : '미사용'}</td>
                </tr>
            `).join('');

            const tableHtml = `
                <button class="btn btn-primary mb-2" onclick="generateSelectedTemplates()">선택 사업자 양식 생성</button>
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th><input type="checkbox" id="manual-template-checkall" onclick="toggleAllManualTemplateCheckboxes(this)"></th>
                                <th>사업자번호</th>
                                <th>사업자명</th>
                                <th>인감날인</th>
                                <th>고객센터안내</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableRows}
                        </tbody>
                    </table>
                </div>
                <button class="btn btn-primary mt-2" onclick="generateSelectedTemplates()">선택 사업자 양식 생성</button>
            `;
            document.getElementById('manualTemplateModalBody').innerHTML = tableHtml;
        }

        function toggleAllManualTemplateCheckboxes(master) {
            const checkboxes = document.querySelectorAll('.manual-template-checkbox');
            checkboxes.forEach(cb => cb.checked = master.checked);
        }

        function generateSelectedTemplates() {
            const checked = Array.from(document.querySelectorAll('.manual-template-checkbox:checked'));
            if (checked.length === 0) {
                alert('사업자를 1개 이상 선택하세요.');
                return;
            }
            if (!confirm('선택한 사업자에 대해 청구서 양식을 생성하시겠습니까?')) return;

            const businessNos = checked.map(cb => cb.value);

            showLoading();
            fetch('/automail/api/templates/generate-selected', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ businessNos })
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                if (data.success) {
                    showMessage('success', `선택 사업자 양식 생성 완료<br>처리 결과: ${data.message || ''}`);
                    bootstrap.Modal.getInstance(document.getElementById('manualTemplateModal')).hide();
                } else {
                    showMessage('danger', '양식 생성 실패: ' + data.message);
                }
            })
            .catch(error => {
                hideLoading();
                showMessage('danger', '양식 생성 중 오류 발생: ' + error.message);
            });
        }
    </script>
</body>
</html> 