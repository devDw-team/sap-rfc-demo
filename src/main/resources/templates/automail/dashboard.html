<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B2B 자동메일 관리 대시보드</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .stat-card.success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        .stat-card.warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        .stat-card.info {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }
        .btn-execute {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            transition: all 0.3s ease;
        }
        .btn-execute:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            color: white;
        }
        .table-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .loading {
            display: none;
        }
        .alert-custom {
            border-radius: 10px;
            border: none;
        }
    </style>
</head>
<body class="bg-light">
    <div class="container-fluid py-4">
        <!-- 헤더 -->
        <div class="row mb-4">
            <div class="col-12">
                <h1 class="display-6 fw-bold text-primary">
                    <i class="fas fa-envelope-open-text me-3"></i>
                    Coway B2B 청구서 자동메일 관리 대시보드
                </h1>
                <p class="text-muted">automail-guide.md Step 1-3 구현 현황 및 관리</p>
            </div>
        </div>

        <!-- 통계 카드 -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-0">오늘 생성</h6>
                            <h3 class="mb-0" th:text="${todayDataCount}">0</h3>
                        </div>
                        <i class="fas fa-calendar-day fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card success">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-0">전체 활성</h6>
                            <h3 class="mb-0" th:text="${totalActiveCount}">0</h3>
                        </div>
                        <i class="fas fa-check-circle fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card info">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-0">파일 생성 완료</h6>
                            <h3 class="mb-0" th:text="${fileCreatedCount}">0</h3>
                        </div>
                        <i class="fas fa-file-alt fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card warning">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-0">메일 발송 완료</h6>
                            <h3 class="mb-0" th:text="${mailSentCount}">0</h3>
                        </div>
                        <i class="fas fa-envelope-circle-check fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- 실행 버튼 -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="table-container">
                    <h5 class="mb-3">
                        <i class="fas fa-play-circle me-2"></i>
                        수동 실행
                    </h5>
                    <div class="row">
                        <div class="col-md-4 mb-2">
                            <button class="btn btn-execute w-100" onclick="executeStep1()">
                                <i class="fas fa-search me-2"></i>
                                Step 1: 대상 조회
                            </button>
                        </div>
                        <div class="col-md-4 mb-2">
                            <button class="btn btn-execute w-100" onclick="executeFullProcess()">
                                <i class="fas fa-cogs me-2"></i>
                                Step 1+2: 전체 실행
                            </button>
                        </div>
                        <div class="col-md-4 mb-2">
                            <button class="btn btn-execute w-100" onclick="executeBatchJob()">
                                <i class="fas fa-rocket me-2"></i>
                                Batch Job 실행
                            </button>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-2">
                            <button class="btn btn-execute w-100" onclick="getFileCreationTargets()">
                                <i class="fas fa-file-search me-2"></i>
                                파일 생성 대상 조회
                            </button>
                        </div>
                        <div class="col-md-4 mb-2">
                            <button class="btn btn-execute w-100" onclick="executeAllFileCreation()">
                                <i class="fas fa-file-export me-2"></i>
                                전체 파일 생성
                            </button>
                        </div>
                        <div class="col-md-4 mb-2">
                            <button class="btn btn-execute w-100" onclick="executeFileCreationBatch()">
                                <i class="fas fa-cogs me-2"></i>
                                파일 생성 배치 실행
                            </button>
                        </div>
                    </div>
                    <!-- Step 4 메일 발송 기능 추가 -->
                    <div class="row">
                        <div class="col-md-4 mb-2">
                            <button class="btn btn-execute w-100" onclick="getMailSendTargets()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                <i class="fas fa-envelope-open me-2"></i>
                                Step 4-1: 메일 발송 대상 조회
                            </button>
                        </div>
                        <div class="col-md-4 mb-2">
                            <button class="btn btn-execute w-100" onclick="executeAllMailSending()" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                                <i class="fas fa-paper-plane me-2"></i>
                                Step 4-2: 전체 메일 발송
                            </button>
                        </div>
                        <div class="col-md-4 mb-2">
                            <button class="btn btn-execute w-100" onclick="executeStep4Batch()" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                                <i class="fas fa-magic me-2"></i>
                                Step 4: 배치 작업 실행
                            </button>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-3">
                            <button class="btn btn-outline-info" onclick="previewMailTemplate()">
                                <i class="fas fa-eye me-2"></i>
                                메일 템플릿 미리보기
                            </button>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-outline-primary" onclick="getMailSendStatistics()">
                                <i class="fas fa-chart-bar me-2"></i>
                                메일 발송 통계
                            </button>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-outline-warning" onclick="viewBatchHistory()">
                                <i class="fas fa-history me-2"></i>
                                배치 실행 이력 조회
                            </button>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-outline-success" onclick="createSampleData()">
                                <i class="fas fa-database me-2"></i>
                                테스트용 샘플 데이터 생성
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 결과 메시지 -->
        <div class="row mb-4">
            <div class="col-12">
                <div id="resultMessage" style="display: none;"></div>
                <div id="loadingMessage" class="alert alert-info alert-custom loading">
                    <i class="fas fa-spinner fa-spin me-2"></i>
                    처리 중입니다...
                </div>
            </div>
        </div>

        <!-- 최근 데이터 목록 -->
        <div class="row">
            <div class="col-12">
                <div class="table-container">
                    <h5 class="mb-3">
                        <i class="fas fa-list me-2"></i>
                        전체 자동메일 데이터 목록
                        <span class="badge bg-primary ms-2" th:text="${#lists.size(recentData)}">0</span>
                    </h5>
                    
                    <!-- 페이징 컨트롤 -->
                    <div class="row mb-3" th:if="${#lists.size(recentData) > 20}">
                        <div class="col-md-6">
                            <div class="d-flex align-items-center">
                                <label for="pageSize" class="form-label me-2 mb-0">페이지당 표시:</label>
                                <select id="pageSize" class="form-select form-select-sm" style="width: auto;" onchange="changePageSize()">
                                    <option value="20">20개</option>
                                    <option value="50">50개</option>
                                    <option value="100">100개</option>
                                    <option value="all">전체</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <nav aria-label="페이지 네비게이션">
                                <ul class="pagination pagination-sm justify-content-end mb-0" id="pagination">
                                    <!-- 페이징 버튼이 JavaScript로 생성됩니다 -->
                                </ul>
                            </nav>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-hover" id="dataTable">
                            <thead class="table-dark">
                                <tr>
                                    <th>SEQ</th>
                                    <th>사업자번호</th>
                                    <th>고객명</th>
                                    <th>묶음번호</th>
                                    <th>주문번호</th>
                                    <th>발송일</th>
                                    <th>청구년월</th>
                                    <th>이메일</th>
                                    <th>파일생성</th>
                                    <th>메일발송</th>
                                    <th>생성일시</th>
                                    <th>액션</th>
                                </tr>
                            </thead>
                            <tbody id="dataTableBody">
                                <tr th:each="data : ${recentData}" th:if="${not #lists.isEmpty(recentData)}" class="data-row">
                                    <td th:text="${data.seq}">1</td>
                                    <td th:text="${data.stcd2}">123-45-67890</td>
                                    <td th:text="${data.custNm}">고객명</td>
                                    <td th:text="${data.zgrpno}">12345</td>
                                    <td th:text="${data.orderNo}">ORDER001</td>
                                    <td th:text="${data.fxday != null ? data.fxday : '-'}">15</td>
                                    <td th:text="${data.recpYm != null ? data.recpYm : '-'}">202401</td>
                                    <td th:text="${data.email}">test@example.com</td>
                                    <td>
                                        <span th:if="${data.fileCreateFlag == 'Y'}" class="badge bg-success">완료</span>
                                        <span th:if="${data.fileCreateFlag == 'N'}" class="badge bg-warning">대기</span>
                                    </td>
                                    <td>
                                        <span th:if="${data.mailSendFlag == 'Y'}" class="badge bg-primary">완료</span>
                                        <span th:if="${data.mailSendFlag == 'N'}" class="badge bg-secondary">대기</span>
                                    </td>
                                    <td th:text="${#temporals.format(data.dtCreateDate, 'yyyy-MM-dd HH:mm')}">2024-01-01 08:00</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary me-1" 
                                                th:onclick="'viewDetail(' + ${data.seq} + ')'">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-success" 
                                                th:onclick="'createFilesForData(' + ${data.seq} + ')'"
                                                th:if="${data.fileCreateFlag == 'N'}">
                                            <i class="fas fa-file-plus"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" 
                                                th:onclick="'sendMailBySeq(' + ${data.seq} + ')'"
                                                th:if="${data.fileCreateFlag == 'Y' and data.mailSendFlag == 'N'}">
                                            <i class="fas fa-paper-plane"></i>
                                        </button>
                                    </td>
                                </tr>
                                <tr th:if="${#lists.isEmpty(recentData)}">
                                    <td colspan="12" class="text-center text-muted py-4">
                                        <i class="fas fa-inbox fa-2x mb-2"></i><br>
                                        생성된 데이터가 없습니다.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 상세 모달 -->
    <div class="modal fade" id="detailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">자동메일 데이터 상세</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="detailContent">
                        <!-- 상세 내용이 여기에 로드됩니다 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Step 1: 대상 조회 실행
        function executeStep1() {
            showLoading();
            fetch('/automail/api/step1/targets')
                .then(response => response.json())
                .then(data => {
                    hideLoading();
                    if (data.success) {
                        showMessage('success', 
                            `Step 1 실행 완료<br>
                            총 조회: ${data.totalCount}건<br>
                            처리 대상: ${data.validCount}건`);
                    } else {
                        showMessage('danger', 'Step 1 실행 실패: ' + data.message);
                    }
                })
                .catch(error => {
                    hideLoading();
                    showMessage('danger', 'Step 1 실행 중 오류 발생: ' + error.message);
                });
        }

        // 전체 프로세스 실행
        function executeFullProcess() {
            showLoading();
            fetch('/automail/api/execute', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    hideLoading();
                    if (data.success) {
                        showMessage('success', 'Step 1+2 전체 프로세스 실행 완료');
                        setTimeout(() => location.reload(), 2000);
                    } else {
                        showMessage('danger', '전체 프로세스 실행 실패: ' + data.message);
                    }
                })
                .catch(error => {
                    hideLoading();
                    showMessage('danger', '전체 프로세스 실행 중 오류 발생: ' + error.message);
                });
        }

        // Batch Job 실행
        function executeBatchJob() {
            showLoading();
            fetch('/automail/api/batch/run', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    hideLoading();
                    if (data.success) {
                        showMessage('success', 'Batch Job 실행 완료');
                        setTimeout(() => location.reload(), 2000);
                    } else {
                        showMessage('danger', 'Batch Job 실행 실패: ' + data.message);
                    }
                })
                .catch(error => {
                    hideLoading();
                    showMessage('danger', 'Batch Job 실행 중 오류 발생: ' + error.message);
                });
        }

        // 상세 보기
        function viewDetail(seq) {
            fetch(`/automail/api/data/${seq}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // 파일 다운로드 버튼 생성 (파일생성플래그가 Y인 경우만)
                        let downloadButtons = '';
                        if (data.data.fileCreateFlag === 'Y') {
                            downloadButtons = `
                                <div class="col-12 mt-3">
                                    <h6>파일 다운로드</h6>
                                    <div class="d-flex gap-2 flex-wrap">
                                        ${data.data.chgHtmlFilenm ? `
                                            <div class="btn-group" role="group">
                                                <button class="btn btn-outline-primary btn-sm" onclick="downloadFile(${seq}, 'html')">
                                                    <i class="fas fa-download me-1"></i>
                                                    HTML 다운로드
                                                </button>
                                                <button class="btn btn-outline-info btn-sm" onclick="previewFile(${seq}, 'html')">
                                                    <i class="fas fa-eye me-1"></i>
                                                    미리보기
                                                </button>
                                            </div>
                                            <small class="text-muted align-self-center ms-2">${data.data.chgHtmlFilenm}</small>
                                        ` : ''}
                                        ${data.data.chgExcelFilenm ? `
                                            <button class="btn btn-outline-success btn-sm" onclick="downloadFile(${seq}, 'excel')">
                                                <i class="fas fa-download me-1"></i>
                                                EXCEL 다운로드
                                                <small class="d-block text-muted">${data.data.chgExcelFilenm}</small>
                                            </button>
                                        ` : ''}
                                    </div>
                                </div>
                            `;
                        }

                        const content = `
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>기본 정보</h6>
                                    <p><strong>SEQ:</strong> ${data.data.seq}</p>
                                    <p><strong>사업자번호:</strong> ${data.data.stcd2 || '-'}</p>
                                    <p><strong>고객명:</strong> ${data.data.custNm || '-'}</p>
                                    <p><strong>고객코드:</strong> ${data.data.kunnr || '-'}</p>
                                    <p><strong>묶음번호:</strong> ${data.data.zgrpno || '-'}</p>
                                    <p><strong>주문번호:</strong> ${data.data.orderNo || '-'}</p>
                                    <p><strong>발송일:</strong> ${data.data.fxday || '-'}</p>
                                    <p><strong>청구년월:</strong> ${data.data.recpYm || '-'}</p>
                                </div>
                                <div class="col-md-6">
                                    <h6>상태 정보</h6>
                                    <p><strong>자동메일플래그:</strong> 
                                        <span class="badge ${data.data.sendAuto === 'Y' ? 'bg-success' : 'bg-secondary'}">${data.data.sendAuto}</span>
                                    </p>
                                    <p><strong>파일생성플래그:</strong> 
                                        <span class="badge ${data.data.fileCreateFlag === 'Y' ? 'bg-success' : 'bg-warning'}">${data.data.fileCreateFlag}</span>
                                    </p>
                                    <p><strong>메일발송플래그:</strong> 
                                        <span class="badge ${data.data.mailSendFlag === 'Y' ? 'bg-primary' : 'bg-secondary'}">${data.data.mailSendFlag}</span>
                                    </p>
                                    <p><strong>삭제플래그:</strong> ${data.data.delFlag}</p>
                                    <p><strong>생성일시:</strong> ${data.data.dtCreateDate}</p>
                                    <p><strong>이메일:</strong> ${data.data.email || '-'}</p>
                                    <p><strong>이메일2:</strong> ${data.data.email2 || '-'}</p>
                                </div>
                                ${downloadButtons}
                            </div>
                            <div class="row mt-3">
                                <div class="col-12">
                                    <h6>파일 정보</h6>
                                    <p><strong>HTML 원본파일명:</strong> ${data.data.oriHtmlFilenm || '-'}</p>
                                    <p><strong>HTML 변환파일명:</strong> ${data.data.chgHtmlFilenm || '-'}</p>
                                    <p><strong>HTML 파일경로:</strong> ${data.data.htmlFilepath || '-'}</p>
                                    <p><strong>EXCEL 원본파일명:</strong> ${data.data.oriExcelFilenm || '-'}</p>
                                    <p><strong>EXCEL 변환파일명:</strong> ${data.data.chgExcelFilenm || '-'}</p>
                                    <p><strong>EXCEL 파일경로:</strong> ${data.data.excelFilepath || '-'}</p>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-12">
                                    <h6>메일 데이터 (JSON)</h6>
                                    <pre class="bg-light p-3 rounded" style="max-height: 300px; overflow-y: auto;">${data.data.mailData || '데이터 없음'}</pre>
                                </div>
                            </div>
                        `;
                        document.getElementById('detailContent').innerHTML = content;
                        new bootstrap.Modal(document.getElementById('detailModal')).show();
                    } else {
                        showMessage('danger', '상세 정보 조회 실패: ' + data.message);
                    }
                })
                .catch(error => {
                    showMessage('danger', '상세 정보 조회 중 오류 발생: ' + error.message);
                });
        }

        // 로딩 표시
        function showLoading() {
            document.getElementById('loadingMessage').style.display = 'block';
            document.getElementById('resultMessage').style.display = 'none';
        }

        // 로딩 숨김
        function hideLoading() {
            document.getElementById('loadingMessage').style.display = 'none';
        }

        // 메시지 표시
        function showMessage(type, message) {
            const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
            const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle';
            
            document.getElementById('resultMessage').innerHTML = `
                <div class="alert ${alertClass} alert-custom">
                    <i class="fas ${icon} me-2"></i>
                    ${message}
                </div>
            `;
            document.getElementById('resultMessage').style.display = 'block';
        }

        // 통계 새로고침
        function refreshStatistics() {
            fetch('/automail/api/statistics')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // 통계 업데이트 로직 (필요시 구현)
                        console.log('통계 새로고침 완료', data.statistics);
                    }
                })
                .catch(error => {
                    console.error('통계 새로고침 실패:', error);
                });
        }

        // 배치 실행 이력 조회
        function viewBatchHistory() {
            fetch('/automail/api/batch/history')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const content = `
                            <div class="row">
                                <div class="col-12">
                                    <h6>배치 실행 현황</h6>
                                    <p><strong>현재 월:</strong> ${data.currentMonth}</p>
                                    <p><strong>이번 달 실행 여부:</strong> 
                                        <span class="badge ${data.hasExecutedThisMonth ? 'bg-success' : 'bg-warning'}">
                                            ${data.hasExecutedThisMonth ? '실행됨' : '미실행'}
                                        </span>
                                    </p>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-12">
                                    <h6>최근 실행 이력</h6>
                                    <pre class="bg-light p-3 rounded" style="max-height: 400px; overflow-y: auto; font-size: 12px;">${data.recentExecutions}</pre>
                                </div>
                            </div>
                        `;
                        document.getElementById('detailContent').innerHTML = content;
                        document.querySelector('#detailModal .modal-title').textContent = '배치 실행 이력';
                        new bootstrap.Modal(document.getElementById('detailModal')).show();
                    } else {
                        showMessage('danger', '배치 실행 이력 조회 실패: ' + data.message);
                    }
                })
                .catch(error => {
                    showMessage('danger', '배치 실행 이력 조회 중 오류 발생: ' + error.message);
                });
        }

        // === 파일 생성 관련 함수들 ===

        // 파일 생성 대상 조회
        function getFileCreationTargets() {
            showLoading();
            fetch('/api/file-creation/targets')
                .then(response => response.json())
                .then(data => {
                    hideLoading();
                    if (data.success) {
                        showMessage('success', 
                            `파일 생성 대상 조회 완료<br>
                            총 대상: ${data.totalCount}건`);
                        
                        // 대상 목록을 모달로 표시
                        if (data.totalCount > 0) {
                            showFileCreationTargets(data.targets);
                        }
                    } else {
                        showMessage('danger', '파일 생성 대상 조회 실패: ' + data.message);
                    }
                })
                .catch(error => {
                    hideLoading();
                    showMessage('danger', '파일 생성 대상 조회 중 오류 발생: ' + error.message);
                });
        }

        // 파일 생성 대상 목록 표시
        function showFileCreationTargets(targets) {
            let tableRows = '';
            targets.forEach(target => {
                tableRows += `
                    <tr>
                        <td>${target.seq}</td>
                        <td>${target.stcd2 || '-'}</td>
                        <td>${target.custNm || '-'}</td>
                        <td>${target.orderNo || '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-success" onclick="createFilesForData(${target.seq})">
                                <i class="fas fa-file-plus"></i> 파일 생성
                            </button>
                        </td>
                    </tr>
                `;
            });

            const content = `
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>SEQ</th>
                                <th>사업자번호</th>
                                <th>고객명</th>
                                <th>주문번호</th>
                                <th>액션</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableRows}
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('detailContent').innerHTML = content;
            document.querySelector('#detailModal .modal-title').textContent = '파일 생성 대상 목록';
            new bootstrap.Modal(document.getElementById('detailModal')).show();
        }

        // 개별 파일 생성
        function createFilesForData(seq) {
            showLoading();
            fetch(`/api/file-creation/create/${seq}`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    hideLoading();
                    if (data.success) {
                        showMessage('success', `SEQ ${seq} 파일 생성 완료`);
                        setTimeout(() => location.reload(), 2000);
                    } else {
                        showMessage('danger', `SEQ ${seq} 파일 생성 실패: ` + data.message);
                    }
                })
                .catch(error => {
                    hideLoading();
                    showMessage('danger', `SEQ ${seq} 파일 생성 중 오류 발생: ` + error.message);
                });
        }

        // 전체 파일 생성
        function executeAllFileCreation() {
            if (!confirm('전체 파일 생성을 실행하시겠습니까?')) {
                return;
            }
            
            showLoading();
            fetch('/api/file-creation/execute-all', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    hideLoading();
                    if (data.success) {
                        showMessage('success', 
                            `전체 파일 생성 완료<br>
                            총 대상: ${data.totalCount}건<br>
                            성공: ${data.successCount}건<br>
                            실패: ${data.failCount}건`);
                        setTimeout(() => location.reload(), 3000);
                    } else {
                        showMessage('danger', '전체 파일 생성 실패: ' + data.message);
                    }
                })
                .catch(error => {
                    hideLoading();
                    showMessage('danger', '전체 파일 생성 중 오류 발생: ' + error.message);
                });
        }

        // 파일 생성 배치 실행
        function executeFileCreationBatch() {
            if (!confirm('파일 생성 배치 작업을 실행하시겠습니까?')) {
                return;
            }
            
            showLoading();
            fetch('/api/file-creation/batch/execute', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    hideLoading();
                    if (data.success) {
                        showMessage('success', '파일 생성 배치 작업 실행 완료');
                        setTimeout(() => location.reload(), 2000);
                    } else {
                        showMessage('danger', '파일 생성 배치 작업 실행 실패: ' + data.message);
                    }
                })
                .catch(error => {
                    hideLoading();
                    showMessage('danger', '파일 생성 배치 작업 실행 중 오류 발생: ' + error.message);
                });
        }

        // 테스트용 샘플 데이터 생성
        function createSampleData() {
            showLoading();
            fetch('/api/file-creation/test/create-sample-data', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    hideLoading();
                    if (data.success) {
                        const content = `
                            <div class="row">
                                <div class="col-12">
                                    <h6>테스트용 샘플 데이터</h6>
                                    <p class="text-info">${data.instruction}</p>
                                    <h6 class="mt-3">샘플 SQL 쿼리:</h6>
                                    <pre class="bg-light p-3 rounded" style="font-size: 12px;">INSERT INTO b2b_automail_dt 
(STCD2, KUNNR, CUST_NM, EMAIL, ZGRPNO, ORDER_NO, SEND_AUTO, FILE_CREATE_FLAG, DEL_FLAG, DT_CREATE_DATE, MAILDATA) 
VALUES 
('1048118121', 'TEST001', '지에스건설(주)', 'test@example.com', 12345, '20BC42405078', 'Y', 'N', 'N', NOW(), '${data.sampleData.replace(/'/g, "\\'")}');</pre>
                                    <h6 class="mt-3">샘플 JSON 데이터:</h6>
                                    <pre class="bg-light p-3 rounded" style="max-height: 400px; overflow-y: auto; font-size: 12px;">${JSON.stringify(JSON.parse(data.sampleData), null, 2)}</pre>
                                </div>
                            </div>
                        `;
                        document.getElementById('detailContent').innerHTML = content;
                        document.querySelector('#detailModal .modal-title').textContent = '테스트용 샘플 데이터';
                        new bootstrap.Modal(document.getElementById('detailModal')).show();
                        
                        showMessage('success', '샘플 데이터 생성 완료');
                    } else {
                        showMessage('danger', '샘플 데이터 생성 실패: ' + data.message);
                    }
                })
                .catch(error => {
                    hideLoading();
                    showMessage('danger', '샘플 데이터 생성 중 오류 발생: ' + error.message);
                });
        }

        // === Step 4 메일 발송 관련 함수들 ===

        // Step 4-1: 메일 발송 대상 조회
        function getMailSendTargets() {
            showLoading();
            fetch('/api/mail-send/targets')
                .then(response => response.json())
                .then(data => {
                    hideLoading();
                    if (data.success) {
                        showMessage('success', 
                            `Step 4-1: 메일 발송 대상 조회 완료<br>
                            총 대상: ${data.totalCount}건`);
                        
                        // 대상 목록을 모달로 표시
                        if (data.totalCount > 0) {
                            showMailSendTargets(data.targets);
                        }
                    } else {
                        showMessage('danger', 'Step 4-1: 메일 발송 대상 조회 실패: ' + data.message);
                    }
                })
                .catch(error => {
                    hideLoading();
                    showMessage('danger', 'Step 4-1: 메일 발송 대상 조회 중 오류 발생: ' + error.message);
                });
        }

        // 메일 발송 대상 목록 표시
        function showMailSendTargets(targets) {
            let tableRows = '';
            targets.forEach(target => {
                tableRows += `
                    <tr>
                        <td>${target.seq}</td>
                        <td>${target.stcd2 || '-'}</td>
                        <td>${target.custNm || '-'}</td>
                        <td>${target.email || '-'}</td>
                        <td>${target.recpYm || '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="sendMailBySeq(${target.seq})">
                                <i class="fas fa-paper-plane"></i> 메일 발송
                            </button>
                        </td>
                    </tr>
                `;
            });

            const content = `
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>SEQ</th>
                                <th>사업자번호</th>
                                <th>고객명</th>
                                <th>이메일</th>
                                <th>청구년월</th>
                                <th>액션</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableRows}
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('detailContent').innerHTML = content;
            document.querySelector('#detailModal .modal-title').textContent = 'Step 4-1: 메일 발송 대상 목록';
            new bootstrap.Modal(document.getElementById('detailModal')).show();
        }

        // 개별 메일 발송
        function sendMailBySeq(seq) {
            if (!confirm(`SEQ ${seq} 건에 대해 메일을 발송하시겠습니까?`)) {
                return;
            }
            
            showLoading();
            fetch(`/api/mail-send/send/${seq}`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    hideLoading();
                    if (data.success) {
                        showMessage('success', `SEQ ${seq} 메일 발송 완료<br>고객: ${data.customerName}`);
                        setTimeout(() => location.reload(), 2000);
                    } else {
                        showMessage('danger', `SEQ ${seq} 메일 발송 실패: ` + data.message);
                    }
                })
                .catch(error => {
                    hideLoading();
                    showMessage('danger', `SEQ ${seq} 메일 발송 중 오류 발생: ` + error.message);
                });
        }

        // Step 4-2: 전체 메일 발송
        function executeAllMailSending() {
            if (!confirm('전체 메일 발송을 실행하시겠습니까?')) {
                return;
            }
            
            showLoading();
            fetch('/api/mail-send/execute-all', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    hideLoading();
                    if (data.success) {
                        showMessage('success', 
                            `Step 4-2: 전체 메일 발송 완료<br>
                            총 대상: ${data.totalCount}건<br>
                            처리 완료: ${data.processedCount}건`);
                        setTimeout(() => location.reload(), 3000);
                    } else {
                        showMessage('danger', 'Step 4-2: 전체 메일 발송 실패: ' + data.message);
                    }
                })
                .catch(error => {
                    hideLoading();
                    showMessage('danger', 'Step 4-2: 전체 메일 발송 중 오류 발생: ' + error.message);
                });
        }

        // Step 4: 배치 작업 실행
        function executeStep4Batch() {
            if (!confirm('Step 4 배치 작업을 실행하시겠습니까?')) {
                return;
            }
            
            showLoading();
            fetch('/api/mail-send/batch/execute', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    hideLoading();
                    if (data.success) {
                        showMessage('success', 
                            `Step 4: 배치 작업 실행 완료<br>
                            실행 시간: ${data.executedAt}`);
                        setTimeout(() => location.reload(), 2000);
                    } else {
                        showMessage('danger', 'Step 4: 배치 작업 실행 실패: ' + data.message);
                    }
                })
                .catch(error => {
                    hideLoading();
                    showMessage('danger', 'Step 4: 배치 작업 실행 중 오류 발생: ' + error.message);
                });
        }

        // 메일 템플릿 미리보기
        function previewMailTemplate() {
            const custNm = prompt('고객명을 입력하세요 (기본값: 테스트고객)', '테스트고객');
            const recpYear = prompt('청구년도를 입력하세요 (기본값: 2024)', '2024');
            const recpMonth = prompt('청구월을 입력하세요 (기본값: 12)', '12');
            
            if (!custNm || !recpYear || !recpMonth) {
                return;
            }
            
            showLoading();
            fetch(`/api/mail-send/preview-template?custNm=${encodeURIComponent(custNm)}&recpYear=${recpYear}&recpMonth=${recpMonth}`)
                .then(response => response.json())
                .then(data => {
                    hideLoading();
                    if (data.success) {
                        const content = `
                            <div class="row">
                                <div class="col-12">
                                    <h6>메일 템플릿 미리보기</h6>
                                    <div class="alert alert-info">
                                        <strong>템플릿 변수:</strong><br>
                                        • 고객명: ${data.custNm}<br>
                                        • 청구년도: ${data.recpYear}년<br>
                                        • 청구월: ${data.recpMonth}월
                                    </div>
                                    <h6>변수 치환 정보:</h6>
                                    <pre class="bg-light p-3 rounded">${JSON.stringify(data.templateVariables, null, 2)}</pre>
                                    <div class="alert alert-warning">
                                        <i class="fas fa-info-circle me-2"></i>
                                        실제 HTML 템플릿 렌더링은 실제 메일 발송 시 확인할 수 있습니다.
                                    </div>
                                </div>
                            </div>
                        `;
                        document.getElementById('detailContent').innerHTML = content;
                        document.querySelector('#detailModal .modal-title').textContent = '메일 템플릿 미리보기';
                        new bootstrap.Modal(document.getElementById('detailModal')).show();
                        
                        showMessage('success', '메일 템플릿 미리보기 생성 완료');
                    } else {
                        showMessage('danger', '메일 템플릿 미리보기 실패: ' + data.message);
                    }
                })
                .catch(error => {
                    hideLoading();
                    showMessage('danger', '메일 템플릿 미리보기 중 오류 발생: ' + error.message);
                });
        }

        // 메일 발송 통계 조회
        function getMailSendStatistics() {
            showLoading();
            fetch('/api/mail-send/statistics')
                .then(response => response.json())
                .then(data => {
                    hideLoading();
                    if (data.success) {
                        const stats = data.statistics;
                        const content = `
                            <div class="row">
                                <div class="col-12">
                                    <h6>메일 발송 통계</h6>
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="card text-center bg-primary text-white">
                                                <div class="card-body">
                                                    <h5>${stats.todayTargetCount}</h5>
                                                    <p class="mb-0">오늘 발송 대상</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="card text-center bg-success text-white">
                                                <div class="card-body">
                                                    <h5>${stats.sentCount}</h5>
                                                    <p class="mb-0">발송 완료</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="card text-center bg-warning text-white">
                                                <div class="card-body">
                                                    <h5>${stats.pendingCount}</h5>
                                                    <p class="mb-0">발송 대기</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mt-3">
                                        <p><strong>마지막 업데이트:</strong> ${stats.lastUpdated}</p>
                                    </div>
                                </div>
                            </div>
                        `;
                        document.getElementById('detailContent').innerHTML = content;
                        document.querySelector('#detailModal .modal-title').textContent = '메일 발송 통계';
                        new bootstrap.Modal(document.getElementById('detailModal')).show();
                        
                        showMessage('success', '메일 발송 통계 조회 완료');
                    } else {
                        showMessage('danger', '메일 발송 통계 조회 실패: ' + data.message);
                    }
                })
                .catch(error => {
                    hideLoading();
                    showMessage('danger', '메일 발송 통계 조회 중 오류 발생: ' + error.message);
                });
        }

        // === 페이징 관련 함수들 ===
        let currentPage = 1;
        let pageSize = 20;
        let totalRows = 0;
        let allRows = [];

        // 페이지 로드 시 페이징 초기화
        document.addEventListener('DOMContentLoaded', function() {
            initializePagination();
            // 5분마다 통계 새로고침
            setInterval(refreshStatistics, 300000);
        });

        // 페이징 초기화
        function initializePagination() {
            const rows = document.querySelectorAll('.data-row');
            allRows = Array.from(rows);
            totalRows = allRows.length;
            
            if (totalRows > 20) {
                showPage(1);
                updatePagination();
            }
        }

        // 페이지 크기 변경
        function changePageSize() {
            const select = document.getElementById('pageSize');
            pageSize = select.value === 'all' ? totalRows : parseInt(select.value);
            currentPage = 1;
            showPage(currentPage);
            updatePagination();
        }

        // 특정 페이지 표시
        function showPage(page) {
            currentPage = page;
            
            if (pageSize >= totalRows) {
                // 전체 표시
                allRows.forEach(row => row.style.display = '');
                return;
            }
            
            const startIndex = (page - 1) * pageSize;
            const endIndex = startIndex + pageSize;
            
            allRows.forEach((row, index) => {
                if (index >= startIndex && index < endIndex) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        // 페이징 버튼 업데이트
        function updatePagination() {
            const pagination = document.getElementById('pagination');
            if (!pagination || pageSize >= totalRows) {
                if (pagination) pagination.innerHTML = '';
                return;
            }
            
            const totalPages = Math.ceil(totalRows / pageSize);
            let paginationHtml = '';
            
            // 이전 버튼
            paginationHtml += `
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="goToPage(${currentPage - 1}); return false;">이전</a>
                </li>
            `;
            
            // 페이지 번호 버튼
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);
            
            if (startPage > 1) {
                paginationHtml += `<li class="page-item"><a class="page-link" href="#" onclick="goToPage(1); return false;">1</a></li>`;
                if (startPage > 2) {
                    paginationHtml += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
            }
            
            for (let i = startPage; i <= endPage; i++) {
                paginationHtml += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="goToPage(${i}); return false;">${i}</a>
                    </li>
                `;
            }
            
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    paginationHtml += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
                paginationHtml += `<li class="page-item"><a class="page-link" href="#" onclick="goToPage(${totalPages}); return false;">${totalPages}</a></li>`;
            }
            
            // 다음 버튼
            paginationHtml += `
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="goToPage(${currentPage + 1}); return false;">다음</a>
                </li>
            `;
            
            pagination.innerHTML = paginationHtml;
        }

        // 페이지 이동
        function goToPage(page) {
            const totalPages = Math.ceil(totalRows / pageSize);
            if (page < 1 || page > totalPages) return;
            
            showPage(page);
            updatePagination();
        }

        // === 파일 다운로드 관련 함수들 ===

        // 파일 다운로드
        function downloadFile(seq, fileType) {
            const url = `/automail/api/download/${seq}/${fileType}`;
            
            showMessage('info', `${fileType.toUpperCase()} 파일 다운로드를 시작합니다.`);
            
            // 간단한 링크 방식으로 다운로드
            const link = document.createElement('a');
            link.href = url;
            link.target = '_blank';
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // 다운로드 완료 메시지는 약간의 지연 후 표시
            setTimeout(() => {
                showMessage('success', `${fileType.toUpperCase()} 파일 다운로드가 시작되었습니다.`);
            }, 500);
        }

        // 파일 미리보기 (HTML 파일의 경우)
        function previewFile(seq, fileType) {
            if (fileType === 'html') {
                const previewUrl = `/automail/api/preview/${seq}/html`;
                
                // 미리보기 창 열기 전에 URL 유효성 검사
                fetch(previewUrl, { method: 'HEAD' })
                    .then(response => {
                        if (response.ok) {
                            window.open(previewUrl, '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
                        } else {
                            throw new Error(`미리보기 실패: ${response.status} ${response.statusText}`);
                        }
                    })
                    .catch(error => {
                        console.error('미리보기 오류:', error);
                        showMessage('danger', `HTML 파일 미리보기 실패: ${error.message}`);
                    });
            } else {
                showMessage('warning', 'EXCEL 파일은 미리보기를 지원하지 않습니다.');
            }
        }
    </script>
</body>
</html> 